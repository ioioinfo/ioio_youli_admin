{% extends 'layout.html' %}
{% block content %}
<!-- 弹出层填写相信信息 -->
<div class="ad-infor" id="add_project">
	<div class="ad-infor-next">
		<p class="one">编号(自动)</p><input type="text" name="" value="{{row.id}}" class="two code" readonly>
	</div>
	<div class="ad-infor-next">
		<p class="one">名称</p><input type="text" name="" value="{{row.name}}" class="two name">
	</div>
	<div class="ad-infor-next">
		<p class="one">价格</p><input type="text" name="" value="{{row.price_text}}" class="two price_text">
	</div>
	<div class="ad-infor-next">
		<p class="one">联系电话</p><input type="text" name="" value="{{row.phone}}" class="two phone">
	</div>
	<div class="ad-infor-next">
		<p class="one">地址</p><input type="text" name="" value="" class="two address">
	</div>
	<div class="ad-infor-next fanli">
		<p class="one">返利方式</p>

			<label style="font-size:14px;margin-left: 50px;"><input name="fan_way" type="radio" value="fanli_bili" {% if row.fanli_bili %}checked{% endif %}/>百分比 </label>

			<label style="font-size:14px;margin-left: 50px;"><input name="fan_way" type="radio" value="fanli_jine" {% if row.fanli_jine %}checked{% endif %} />固定金额 </label>

	</div>

	<div class="ad-infor-next">
		<p class="one">返利比例(%)</p><input type="text" name="" value="{{row.fanli_bili}}" class="two fanli_bili">
	</div>
	<div class="ad-infor-next">
		<p class="one">返利金额</p><input type="text" name="" value="{{row.fanli_jine}}" class="two fanli_jine" readonly>
	</div>

	<div class="ad-infor-next tuijian">
		<p class="one">推荐返利方式</p>
		<label style="font-size:14px;margin-left: 50px;"><input name="tuijian_fanli_fangshi" type="radio" value="tuijian_fanli_bili" {% if row.tuijian_fanli_bili %}checked{% endif %}/>百分比 </label>
		<label style="font-size:14px;margin-left: 50px;"><input name="tuijian_fanli_fangshi" type="radio" value="tuijian_fanli_jine" {% if row.tuijian_fanli_jine %}checked{% endif %}/>固定金额 </label>
	</div>

	<div class="ad-infor-next">
		<p class="one">推荐返利比例</p><input type="text" name="" value="{{row.tuijian_fanli_bili}}" class="two tuijian_fanli_bili">
	</div>
	<div class="ad-infor-next">
		<p class="one">推荐返利金额</p><input type="text" name="" value="{{row.tuijian_fanli_jine}}" class="two tuijian_fanli_jine" readOnly>
	</div>

	<div class="ad-infor-next">
		<p class="one">项目优势</p><textarea class="three item_advantage">{{row.xiangmuyoushi|safe}}</textarea>
	</div>
	<div class="ad-infor-next">
		<p class="one">项目描述</p><textarea class="three item_describe">{{row.description|safe}}</textarea>
	</div>

	<div class="ad-infor-next">
		<p class="one">上传图片</p><input type="file" name="files" value="" class="four image" id="fileupload" multiple>
	</div>
	<div id="add_pictures">
		{% for image in row.images %}
			{% if image.is_main_image==1 %}
				<div><img src="http://211.149.248.241:18102/images/{{image.url}}" width="50px"/><input type='submit' value='主图 删除' class='image_delete'></div>
			{% else %}
				<div><img src="http://211.149.248.241:18102/images/{{image.url}}" width="30px"/><input type='submit' value='删除' class='image_delete'></div>
			{% endif %}
		{% endfor %}
	</div>
	<div class="ad-infor-next float-right">
		<input type="submit" name="" value="取消" class="five five-backgroung" id="add_cancel">
		<input type="submit" name="" value="预览" class="five">
		<input type="submit" name="" value="保存" class="five" id="save" data-id="{{row.id}}" data-tenant="{{row.tenant_id}}">
		<input type="submit" name="" value="返回" class="five" id="back">
	</div>

</div>


{% endblock %}
{% block script %}
<script>
$(function() {
	var images = [];
	var project_infos = {
		images : [],
		code : null,
		name : null,
		price_text : null,
		address : null,
		fanli_fangshi : "fanli_bili",
		fanli_bili : null,
		fanli_jine : null,
		tuijian_fanli_fangshi : "tuijian_fanli_bili",
		tuijian_fanli_bili : null,
		tuijian_fanli_jine : null,
		phone : null,
		description : null,
		xiangmuyoushi : null,
		main_image_url : null
	};


		//上传图片
		$('#fileupload').fileupload({
		   url: "/do_upload",
		   dataType: 'json',
		   done: function (e, data) {
			  images.push(data._response.result.src);
			  var t = _.template($("#add_pictures_infos").html());
			  $("#add_pictures").html(t({images:images}));
			}
		});
		//上传图片删除
		$(".image_delete").click(function(){
			var id = $(this).data("id");
			images.splice(id,1);
			var t = _.template($("#add_pictures_infos").html());
			$("#add_pictures").html(t({images:images}));
		});
		//input radio框改变
		$(".fanli input").change(function(){
			 $(".fanli_bili").val("");
			 $(".fanli_jine").val("");
			 $(".fanli_bili").attr("readOnly","true");
			 $(".fanli_jine").attr("readOnly","true");
			 var r = $(this).is(":checked");
			 if (r) {
				 var value = $(this).attr("value");
				 project_infos.fanli_fangshi = value;
				 $("."+value).removeAttr("readOnly");
			 }
		 });
		$(".tuijian input").change(function(){
			 $(".tuijian_fanli_bili").val("");
			 $(".tuijian_fanli_jine").val("");
			 $(".tuijian_fanli_bili").attr("readOnly","true");
			 $(".tuijian_fanli_jine").attr("readOnly","true");
			 var r = $(this).is(":checked");
			 if (r) {
				 var value = $(this).attr("value");
				 project_infos.tuijian_fanli_fangshi = value;
				 $("."+value).removeAttr("readOnly");
			 }
		 });
		//保存
		$("#save").click(function(){
			var id = $(this).data("id");
			var tenant_id = $(this).data("tenant");
			 project_infos.code = $(".code").val();
			 project_infos.name = $(".name").val();
			 if (!project_infos.name) {
				 alert("名称必填！")
				 return;
			 }
			 project_infos.tenant_id = tenant_id;
			 project_infos.price_text = $(".price_text").val();
			 project_infos.address = $(".address").val();
			 if (project_infos.fanli_fangshi == "fanli_bili") {
				 project_infos.fanli_bili = $(".fanli_bili").val();
				 if (!project_infos.fanli_bili) {
				 	alert("返利比例必填！")
					return;
				 }
				 project_infos.fanli_jine = null;
			 }else {
				 project_infos.fanli_jine = $(".fanli_jine").val();
				 if (!project_infos.fanli_jine) {
				 	alert("返利金额必填！")
					return;
				 }
				 project_infos.fanli_bili = null;
			 }
			 if (project_infos.tuijian_fanli_fangshi == "tuijian_fanli_bili") {
				 project_infos.tuijian_fanli_bili = $(".tuijian_fanli_bili").val();
				 if (!project_infos.tuijian_fanli_bili) {
				 	alert("推荐返利比例必填！")
					return;
				 }
				 project_infos.tuijian_fanli_jine = null;
			 }else {
				 project_infos.tuijian_fanli_jine = $(".tuijian_fanli_jine").val();
				 if (!project_infos.tuijian_fanli_jine) {
				   alert("推荐返利金额必填！")
				   return;
				}
				project_infos.tuijian_fanli_bili = null;
			 }
			 project_infos.id = id;
			 project_infos.phone = $(".phone").val();
			 project_infos.description = $(".item_describe").val();
			 project_infos.xiangmuyoushi = $(".item_describe").val();
			 project_infos.main_image_url = images[0];
			 project_infos.images = images;
			 console.log(JSON.stringify(project_infos));
			 $.post("/update_project",{project_infos:JSON.stringify(project_infos)},function(data){
				 if (data.success) {
				 	alert("保存成功！");
				 }
			 })
		 });
		 $("#back").click(function(){
			 location.href = "/shelve_projects";
		 });

	$(".list-infor4").addClass("hover");
	$(".ad-infor").css("display","block");
	$(".name").focus();
	$("#add_cancel").click(function(){
		location.href ="/add_project";
	});
});
</script>
{% endblock %}
